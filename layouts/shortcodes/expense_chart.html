<div style="width: 300px; height: 300px; margin: 0 auto;">
    <canvas id="expenseChart-{{ .Get 1 }}"></canvas>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    fetch('{{ .Get 0 }}')
        .then(response => response.text())
        .then(csvText => {
            const rows = csvText.trim().split('\n').slice(1);
            const categories = {};
            rows.forEach(row => {
                const cols = row.split(',');
                const month = cols[0].trim();
                const category = cols[1].trim();
                const amount = parseFloat(cols[4].trim());
                if (month === '{{ .Get 1 }}') {
                    if (!categories[category]) {
                        categories[category] = 0;
                    }
                    categories[category] += amount;
                }
            });

            const icons = {
                'Корма': '/icons/dog_food.svg',
                'Медикаменты': '/icons/veterinary.svg',
                'Обработка от паразитов': '/icons/ticks.svg'
                // Добавьте пути к иконкам для других категорий
            };

            const ctx = document.getElementById('expenseChart-{{ .Get 1 }}').getContext('2d');

            // Загружаем иконки в Image объекты
            const iconImages = {};
            for (const [category, url] of Object.entries(icons)) {
                const img = new Image();
                img.src = url;
                iconImages[category] = img;
            }

            // Создаем кастомный плагин для заполнения иконками
            const iconPlugin = {
                id: 'iconPlugin',
                beforeDraw(chart) {
                    const ctx = chart.ctx;
                    const dataset = chart.data.datasets[0];
                    const meta = chart.getDatasetMeta(0);

                    meta.data.forEach((arc, index) => {
                        const category = chart.data.labels[index];
                        const iconImg = iconImages[category];
                        if (iconImg && arc) {
                            // Координаты центра и радиус арки
                            const centerX = (arc.x + arc.x) / 2;
                            const centerY = (arc.y + arc.y) / 2;
                            const outerRadius = arc.outerRadius;
                            const innerRadius = arc.innerRadius;
                            const startAngle = arc.startAngle;
                            const endAngle = arc.endAngle;
                            const iconSize = 20; // размер иконки
                            const iconPadding = iconSize / 2; // отступ между иконками

                            ctx.save();
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.arc(centerX, centerY, outerRadius, startAngle, endAngle);
                            ctx.arc(centerX, centerY, innerRadius, endAngle, startAngle, true);
                            ctx.closePath();
                            ctx.clip();

                            // Заливаем область иконками
                            const radiusStep = iconSize + iconPadding;
                            const angleStep = (iconSize + iconPadding) / outerRadius;
                            for (let r = innerRadius + iconPadding; r < outerRadius; r += radiusStep) {
                                for (let angle = startAngle; angle < endAngle; angle += angleStep) {
                                    const x = centerX + r * Math.cos(angle);
                                    const y = centerY + r * Math.sin(angle);

                                    // Устанавливаем цвет
                                    ctx.fillStyle = chart.data.datasets[0].borderColor[index];
                                    ctx.globalAlpha = 0.5; // Полупрозрачный эффект

                                    ctx.drawImage(iconImg, x - iconSize / 2, y - iconSize / 2, iconSize, iconSize);
                                }
                            }

                            ctx.restore();
                        }
                    });
                }
            };

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [iconPlugin]
            });
        });
});
</script>
